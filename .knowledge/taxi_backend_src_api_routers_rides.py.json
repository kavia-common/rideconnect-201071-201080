{"is_source_file": true, "format": "Python", "description": "This file defines API routes for managing 'rides' in a backend service using FastAPI and SQLAlchemy. It includes functions for creating rides, assigning drivers, updating ride status, fetching ride details, listing user rides, and retrieving ride event history. The functions enforce access control, handle ride status transitions, and emit real-time updates via WebSockets.", "external_files": ["src.api.db", "src.api.deps", "src.api.models.driver", "src.api.models.ride", "src.api.models.user", "src.api.schemas.ride", "src.api.realtime"], "external_methods": ["get_db", "get_current_user", "require_driver", "broadcast_to_ride", "anyio.from_thread.run"], "published": ["create_ride", "assign_driver", "update_ride_status", "get_ride", "list_rides", "get_ride_history"], "classes": [], "methods": [{"name": "datetime _utcnow()", "description": "Returns the current UTC datetime with timezone awareness.", "scope": "", "scopeKind": ""}, {"name": "RidePublic _to_public(ride: Ride)", "description": "Converts a Ride ORM object to its public schema representation.", "scope": "", "scopeKind": ""}, {"name": "RideEventPublic _to_event_public(ev: RideEvent)", "description": "Converts a RideEvent ORM object to its public schema representation.", "scope": "", "scopeKind": ""}, {"name": "HTTPException _forbidden(detail: str)", "description": "Creates an HTTP 403 Forbidden exception with a given message.", "scope": "", "scopeKind": ""}, {"name": "HTTPException _not_found()", "description": "Creates an HTTP 404 Not Found exception for Ride not found.", "scope": "", "scopeKind": ""}, {"name": "None _ensure_user_can_view_ride(current_user: User, ride: Ride)", "description": "Checks if the current user is either the rider or the assigned driver of the ride.", "scope": "", "scopeKind": ""}, {"name": "None _ensure_driver_can_modify_ride(driver_user: User, ride: Ride)", "description": "Verifies if the driver can modify the ride, e.g., is the assigned driver or unassigned.", "scope": "", "scopeKind": ""}, {"name": "Dict[RideStatus,set[RideStatus]] _allowed_transitions()", "description": "Defines allowed status transitions for rides.", "scope": "", "scopeKind": ""}, {"name": "None _validate_transition(current: RideStatus, new: RideStatus)", "description": "Validates if a transition from current to new status is permissible.", "scope": "", "scopeKind": ""}, {"name": "None _add_event(db: Session, ride: Ride, event_type: str, payload: Optional[Dict[str, Any]] = None)", "description": " adds a RideEvent record to the database for a ride.", "scope": "", "scopeKind": ""}, {"name": "None add_ride_event(db: Session, *, ride_id: UUID, event_type: str, payload: Optional[Dict[str, Any]] = None)", "description": "Adds an event to the ride's event log; intended for real-time handling.", "scope": "", "scopeKind": ""}, {"name": "None _broadcast_ride_status(ride: Ride, *, by_user_id: UUID, old_status: RideStatus, new_status: RideStatus)", "description": "Sends ride status updates over WebSocket channels to clients.", "scope": "", "scopeKind": ""}, {"name": "RidePublic create_ride( payload: RideCreateRequest, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "API endpoint to create a new ride request, only accessible by riders.", "scope": "", "scopeKind": ""}, {"name": "RidePublic assign_driver( ride_id: UUID, payload: RideAssignRequest, db: Session = Depends(get_db), current_driver_user: User = Depends(require_driver), )", "description": "API endpoint for drivers to assign themselves to a requested ride.", "scope": "", "scopeKind": ""}, {"name": "RidePublic update_ride_status( ride_id: UUID, payload: RideStatusUpdateRequest, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "API endpoint for updating ride status, enforced based on user role.", "scope": "", "scopeKind": ""}, {"name": "RidePublic get_ride( ride_id: UUID, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "API endpoint to retrieve ride details, accessible by rider or driver.", "scope": "", "scopeKind": ""}, {"name": "List[RidePublic] list_rides( role: str = Query(..., pattern=\"^(rider|driver)$\", description=\"List rides for current user as rider or driver.\"), status_filter: Optional[RideStatus] = Query(default=None, alias=\"status\", description=\"Optional ride status filter.\"), limit: int = Query(default=50, ge=1, le=200, description=\"Max rides to return.\"), offset: int = Query(default=0, ge=0, description=\"Offset for pagination.\"), db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "Lists rides associated with the current user, filtered by role and optional status.", "scope": "", "scopeKind": ""}, {"name": "RideHistoryResponse get_ride_history( ride_id: UUID, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "Returns the chronological event history of a ride if authorized.", "scope": "", "scopeKind": ""}], "search-terms": ["rides.py", "FastAPI", "ride creation", "driver assignment", "ride status update", "ride retrieval", "ride listing", "ride event history", "WebSocket broadcast", "SQLAlchemy ORM", "RideStatus", "RidePublic"], "state": 2, "file_id": 22, "knowledge_revision": 53, "git_revision": "b934407af2b875323605d904bf78ec1e175e0b70", "revision_history": [{"47": ""}, {"53": "b934407af2b875323605d904bf78ec1e175e0b70"}], "ctags": [{"_type": "tag", "name": "_add_event", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _add_event(db: Session, ride: Ride, event_type: str, payload: Optional[Dict[str, Any]] = Non/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(db: Session, ride: Ride, event_type: str, payload: Optional[Dict[str, Any]] = None)"}, {"_type": "tag", "name": "_allowed_transitions", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _allowed_transitions() -> Dict[RideStatus, set[RideStatus]]:$/", "language": "Python", "typeref": "typename:Dict[RideStatus,set[RideStatus]]", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "_broadcast_ride_status", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^async def _broadcast_ride_status(ride: Ride, *, by_user_id: UUID, old_status: RideStatus, new_st/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(ride: Ride, *, by_user_id: UUID, old_status: RideStatus, new_status: RideStatus)"}, {"_type": "tag", "name": "_ensure_driver_can_modify_ride", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _ensure_driver_can_modify_ride(driver_user: User, ride: Ride) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(driver_user: User, ride: Ride)"}, {"_type": "tag", "name": "_ensure_user_can_view_ride", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _ensure_user_can_view_ride(current_user: User, ride: Ride) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(current_user: User, ride: Ride)"}, {"_type": "tag", "name": "_forbidden", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _forbidden(detail: str) -> HTTPException:$/", "language": "Python", "typeref": "typename:HTTPException", "kind": "function", "signature": "(detail: str)"}, {"_type": "tag", "name": "_not_found", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _not_found() -> HTTPException:$/", "language": "Python", "typeref": "typename:HTTPException", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "_to_event_public", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _to_event_public(ev: RideEvent) -> RideEventPublic:$/", "language": "Python", "typeref": "typename:RideEventPublic", "kind": "function", "signature": "(ev: RideEvent)"}, {"_type": "tag", "name": "_to_public", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _to_public(ride: Ride) -> RidePublic:$/", "language": "Python", "typeref": "typename:RidePublic", "kind": "function", "signature": "(ride: Ride)"}, {"_type": "tag", "name": "_utcnow", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _utcnow() -> datetime:$/", "language": "Python", "typeref": "typename:datetime", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "_validate_transition", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _validate_transition(current: RideStatus, new: RideStatus) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(current: RideStatus, new: RideStatus)"}, {"_type": "tag", "name": "add_ride_event", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^async def add_ride_event(db: Session, *, ride_id: UUID, event_type: str, payload: Optional[Dict[/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(db: Session, *, ride_id: UUID, event_type: str, payload: Optional[Dict[str, Any]] = None)"}, {"_type": "tag", "name": "assign_driver", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def assign_driver($/", "language": "Python", "typeref": "typename:RidePublic", "kind": "function", "signature": "( ride_id: UUID, payload: RideAssignRequest, db: Session = Depends(get_db), current_driver_user: User = Depends(require_driver), )"}, {"_type": "tag", "name": "create_ride", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def create_ride($/", "language": "Python", "typeref": "typename:RidePublic", "kind": "function", "signature": "( payload: RideCreateRequest, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}, {"_type": "tag", "name": "get_ride", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def get_ride($/", "language": "Python", "typeref": "typename:RidePublic", "kind": "function", "signature": "( ride_id: UUID, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}, {"_type": "tag", "name": "get_ride_history", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def get_ride_history($/", "language": "Python", "typeref": "typename:RideHistoryResponse", "kind": "function", "signature": "( ride_id: UUID, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}, {"_type": "tag", "name": "list_rides", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def list_rides($/", "language": "Python", "typeref": "typename:List[RidePublic]", "kind": "function", "signature": "( role: str = Query(..., pattern=\"^(rider|driver)$\", description=\"List rides for current user as rider or driver.\"), status_filter: Optional[RideStatus] = Query(default=None, alias=\"status\", description=\"Optional ride status filter.\"), limit: int = Query(default=50, ge=1, le=200, description=\"Max rides to return.\"), offset: int = Query(default=0, ge=0, description=\"Offset for pagination.\"), db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}, {"_type": "tag", "name": "router", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^router = APIRouter(prefix=\"\\/rides\", tags=[\"rides\"])$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "update_ride_status", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def update_ride_status($/", "language": "Python", "typeref": "typename:RidePublic", "kind": "function", "signature": "( ride_id: UUID, payload: RideStatusUpdateRequest, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}], "hash": "310908f320d97b1ecac0cf1196119127", "format-version": 4, "code-base-name": "taxi_backend", "filename": "taxi_backend/src/api/routers/rides.py", "fields": [{"name": "router = APIRouter(prefix=\"\\/rides\", tags=[\"rides\"])", "scope": "", "scopeKind": "", "description": "unavailable"}]}