{"is_source_file": true, "format": "Python", "description": "This file defines API routes for managing 'rides' in a ride-sharing backend system with FastAPI. It includes endpoints for creating rides, assigning drivers, updating ride status, fetching ride details, listing user rides, and getting ride event history. Utility functions for converting ORM models to public schemas, enforcing permission checks, validating state transitions, and logging ride events are also present.", "external_files": ["src.api.db", "src.api.deps", "src.api.models.driver", "src.api.models.ride", "src.api.models.user", "src.api.schemas.ride"], "external_methods": ["get_db", "get_current_user", "require_driver"], "published": ["router"], "classes": [{"name": "RideAssignRequest", "description": "Schema for assigning a driver to a ride."}, {"name": "RideCreateRequest", "description": "Schema for creating a new ride."}, {"name": "RideEventPublic", "description": "Schema representing public ride event data."}, {"name": "RideHistoryResponse", "description": "Schema for returning ride's event history."}, {"name": "RidePublic", "description": "Schema for ride data exposed publicly."}, {"name": "RideStatusUpdateRequest", "description": "Schema for updating the status of a ride."}], "methods": [{"name": "datetime _utcnow()", "description": "Returns current UTC timestamp with timezone awareness.", "scope": "", "scopeKind": ""}, {"name": "RidePublic _to_public(ride: Ride)", "description": "Converts Ride ORM object to RidePublic schema.", "scope": "", "scopeKind": ""}, {"name": "RideEventPublic _to_event_public(ev: RideEvent)", "description": "Converts RideEvent ORM object to RideEventPublic schema.", "scope": "", "scopeKind": ""}, {"name": "HTTPException _forbidden(detail: str)", "description": "Creates a standardized HTTP 403 Forbidden error.", "scope": "", "scopeKind": ""}, {"name": "HTTPException _not_found()", "description": "Creates a standardized HTTP 404 Not Found error.", "scope": "", "scopeKind": ""}, {"name": "None _ensure_user_can_view_ride(current_user: User, ride: Ride)", "description": "Checks if the current user has access to view the ride.", "scope": "", "scopeKind": ""}, {"name": "None _ensure_driver_can_modify_ride(driver_user: User, ride: Ride)", "description": "Checks if the driver can modify the ride (assigned to them).", "scope": "", "scopeKind": ""}, {"name": "Dict[RideStatus,set[RideStatus]] _allowed_transitions()", "description": "Defines allowed status transitions for rides.", "scope": "", "scopeKind": ""}, {"name": "None _validate_transition(current: RideStatus, new: RideStatus)", "description": "Validates that a ride status transition is valid, raises 409 if invalid.", "scope": "", "scopeKind": ""}, {"name": "None _add_event(db: Session, ride: Ride, event_type: str, payload: Optional[Dict[str, Any]] = None)", "description": "Logs a new ride event into the database.", "scope": "", "scopeKind": ""}, {"name": "RidePublic create_ride( payload: RideCreateRequest, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "Endpoint to create a new ride, only accessible by users with 'rider' role.", "scope": "", "scopeKind": ""}, {"name": "RidePublic assign_driver( ride_id: UUID, payload: RideAssignRequest, db: Session = Depends(get_db), current_driver_user: User = Depends(require_driver), )", "description": "Endpoint for a driver to assign themselves to a ride in 'requested' status.", "scope": "", "scopeKind": ""}, {"name": "RidePublic update_ride_status( ride_id: UUID, payload: RideStatusUpdateRequest, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "Endpoint to change the status of a ride, with role-based restrictions and transition validation.", "scope": "", "scopeKind": ""}, {"name": "RidePublic get_ride( ride_id: UUID, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "Retrieves detailed info for a specific ride if the user is a participant.", "scope": "", "scopeKind": ""}, {"name": "List[RidePublic] list_rides( role: str = Query(..., pattern=\"^(rider|driver)$\", description=\"List rides for current user as rider or driver.\"), status_filter: Optional[RideStatus] = Query(default=None, alias=\"status\", description=\"Optional ride status filter.\"), limit: int = Query(default=50, ge=1, le=200, description=\"Max rides to return.\"), offset: int = Query(default=0, ge=0, description=\"Offset for pagination.\"), db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "Lists rides for the current user, filtered by role and optional status, with pagination.", "scope": "", "scopeKind": ""}, {"name": "RideHistoryResponse get_ride_history( ride_id: UUID, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "Returns the chronological event history of a ride.", "scope": "", "scopeKind": ""}], "calls": ["select()", "select(Ride).where()", "select(RideEvent).where()", "select(Driver).where()", "db.scalar()", "db.scalars()", "db.add()", "db.commit()", "db.refresh()", "db.close()"], "search-terms": ["rides creation endpoint", "driver assignment route", "ride status update logic", "ride event history retrieval", "role-based ride listing", "ride transition validation", "public ride schema", "rides API with FastAPI"], "state": 2, "file_id": 22, "knowledge_revision": 47, "git_revision": "", "ctags": [{"_type": "tag", "name": "_add_event", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _add_event(db: Session, ride: Ride, event_type: str, payload: Optional[Dict[str, Any]] = Non/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(db: Session, ride: Ride, event_type: str, payload: Optional[Dict[str, Any]] = None)"}, {"_type": "tag", "name": "_allowed_transitions", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _allowed_transitions() -> Dict[RideStatus, set[RideStatus]]:$/", "language": "Python", "typeref": "typename:Dict[RideStatus,set[RideStatus]]", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "_ensure_driver_can_modify_ride", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _ensure_driver_can_modify_ride(driver_user: User, ride: Ride) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(driver_user: User, ride: Ride)"}, {"_type": "tag", "name": "_ensure_user_can_view_ride", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _ensure_user_can_view_ride(current_user: User, ride: Ride) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(current_user: User, ride: Ride)"}, {"_type": "tag", "name": "_forbidden", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _forbidden(detail: str) -> HTTPException:$/", "language": "Python", "typeref": "typename:HTTPException", "kind": "function", "signature": "(detail: str)"}, {"_type": "tag", "name": "_not_found", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _not_found() -> HTTPException:$/", "language": "Python", "typeref": "typename:HTTPException", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "_to_event_public", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _to_event_public(ev: RideEvent) -> RideEventPublic:$/", "language": "Python", "typeref": "typename:RideEventPublic", "kind": "function", "signature": "(ev: RideEvent)"}, {"_type": "tag", "name": "_to_public", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _to_public(ride: Ride) -> RidePublic:$/", "language": "Python", "typeref": "typename:RidePublic", "kind": "function", "signature": "(ride: Ride)"}, {"_type": "tag", "name": "_utcnow", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _utcnow() -> datetime:$/", "language": "Python", "typeref": "typename:datetime", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "_validate_transition", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def _validate_transition(current: RideStatus, new: RideStatus) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(current: RideStatus, new: RideStatus)"}, {"_type": "tag", "name": "assign_driver", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def assign_driver($/", "language": "Python", "typeref": "typename:RidePublic", "kind": "function", "signature": "( ride_id: UUID, payload: RideAssignRequest, db: Session = Depends(get_db), current_driver_user: User = Depends(require_driver), )"}, {"_type": "tag", "name": "create_ride", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def create_ride($/", "language": "Python", "typeref": "typename:RidePublic", "kind": "function", "signature": "( payload: RideCreateRequest, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}, {"_type": "tag", "name": "get_ride", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def get_ride($/", "language": "Python", "typeref": "typename:RidePublic", "kind": "function", "signature": "( ride_id: UUID, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}, {"_type": "tag", "name": "get_ride_history", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def get_ride_history($/", "language": "Python", "typeref": "typename:RideHistoryResponse", "kind": "function", "signature": "( ride_id: UUID, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}, {"_type": "tag", "name": "list_rides", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def list_rides($/", "language": "Python", "typeref": "typename:List[RidePublic]", "kind": "function", "signature": "( role: str = Query(..., pattern=\"^(rider|driver)$\", description=\"List rides for current user as rider or driver.\"), status_filter: Optional[RideStatus] = Query(default=None, alias=\"status\", description=\"Optional ride status filter.\"), limit: int = Query(default=50, ge=1, le=200, description=\"Max rides to return.\"), offset: int = Query(default=0, ge=0, description=\"Offset for pagination.\"), db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}, {"_type": "tag", "name": "router", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^router = APIRouter(prefix=\"\\/rides\", tags=[\"rides\"])$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "update_ride_status", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/routers/rides.py", "pattern": "/^def update_ride_status($/", "language": "Python", "typeref": "typename:RidePublic", "kind": "function", "signature": "( ride_id: UUID, payload: RideStatusUpdateRequest, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}], "hash": "4b024c30c05e76796f88ad127c47eb58", "format-version": 4, "code-base-name": "taxi_backend", "filename": "taxi_backend/src/api/routers/rides.py", "fields": [{"name": "router = APIRouter(prefix=\"\\/rides\", tags=[\"rides\"])", "scope": "", "scopeKind": "", "description": "unavailable"}], "revision_history": [{"47": ""}]}