{"is_source_file": true, "format": "Python", "description": "This file implements an in-memory WebSocket-based real-time broker for ride-specific communication channels in a ride-sharing backend. It manages WebSocket connections, room subscriptions, message broadcasting, heartbeat pings, and authorization logic for rider, driver, and admin channels. The code facilitates real-time location updates and status broadcasts for ride sessions.", "external_files": ["src.api.models.ride", "src.api.models.user", "src.api.security", "src.api.routers.rides"], "external_methods": ["decode_token", "add_ride_event"], "published": ["broadcast_to_ride", "authenticate_ws_user", "authorize_ws_ride_access", "_heartbeat_sender", "run_ws_session"], "classes": [{"name": "Connection", "description": "Represents an active WebSocket client connection, including user identity, role, and connection timestamp."}, {"name": "RideRoom", "description": "Manages WebSocket connections within a specific ride, tracking riders, drivers, admins, and last known location, with thread-safe add/remove operations."}, {"name": "InMemoryRideBroker", "description": "Keeps track of all active ride rooms, providing methods to get or create rooms and cleanup empty rooms."}], "methods": [{"name": "None broadcast_to_ride( ride_id: UUID, payload: dict[str, Any], *, to_riders: bool = True, to_drivers: bool = True, to_admins: bool = True, )", "description": "Broadcasts a message payload to all specified subscriber groups within a ride room, handling stale connections cleanup.", "scope": "", "scopeKind": ""}, {"name": "User authenticate_ws_user(websocket: WebSocket, db: Session)", "description": "Authenticates a WebSocket user using JWT token from headers or query parameters, verifies user existence in database.", "scope": "", "scopeKind": ""}, {"name": "None authorize_ws_ride_access(user: User, ride: Ride, channel: str)", "description": "Checks if a user has permission to access a specific ride channel based on their role and ride association.", "scope": "", "scopeKind": ""}, {"name": "None _heartbeat_sender(conn: Connection, stop_event: asyncio.Event)", "description": "Periodically sends ping messages to keep WebSocket connections alive and detects disconnections.", "scope": "", "scopeKind": ""}, {"name": "None run_ws_session( websocket: WebSocket, *, db: Session, ride_id: UUID, channel: str, )", "description": "Main WebSocket session handling, including authentication, room joining, message handling, location updates, heartbeat, and cleanup.", "scope": "", "scopeKind": ""}, {"name": "__init__(self)", "scope": "InMemoryRideBroker", "scopeKind": "class", "description": "unavailable"}, {"name": "__init__(self, ride_id: UUID)", "scope": "RideRoom", "scopeKind": "class", "description": "unavailable"}, {"name": "int _close_code(code: int)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Optional[str] _extract_token_from_ws(websocket: WebSocket)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "bool _safe_send_json(conn: Connection, payload: dict[str, Any])", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "None add(self, conn: Connection, channel: str)", "scope": "RideRoom", "scopeKind": "class", "description": "unavailable"}, {"name": "None cleanup_if_empty(self, ride_id: UUID)", "scope": "InMemoryRideBroker", "scopeKind": "class", "description": "unavailable"}, {"name": "RideRoom get_room(self, ride_id: UUID)", "scope": "InMemoryRideBroker", "scopeKind": "class", "description": "unavailable"}, {"name": "None remove(self, user_id: UUID)", "scope": "RideRoom", "scopeKind": "class", "description": "unavailable"}, {"name": "dict[str,Any] snapshot(self)", "scope": "RideRoom", "scopeKind": "class", "description": "unavailable"}], "calls": ["json.dumps", "decode_token", "select", "select(User).where(User.id == user_id)", "asyncio.wait_for", "websocket.send_text", "websocket.close", "add_ride_event", "broadcast_to_ride", "asyncio.create_task", "asyncio.Event", "asyncio.sleep", "websocket.receive_json", "websocket.send_json"], "search-terms": ["WebSocket in-memory broker", "ride WebSocket channels", "real-time ride location", "WebSocket authentication JWT", "ride room management", "in-memory WebSocket server", "location updates", "WebSocket connection management"], "state": 2, "file_id": 23, "knowledge_revision": 56, "git_revision": "", "revision_history": [{"52": ""}, {"56": ""}], "ctags": [{"_type": "tag", "name": "Connection", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^class Connection:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "InMemoryRideBroker", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^class InMemoryRideBroker:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "MAX_CONSECUTIVE_SEND_TIMEOUTS", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^MAX_CONSECUTIVE_SEND_TIMEOUTS = 3$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "PING_INTERVAL_SECONDS", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^PING_INTERVAL_SECONDS = 20$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "RideRoom", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^class RideRoom:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "SEND_TIMEOUT_SECONDS", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^SEND_TIMEOUT_SECONDS = 3$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "__init__", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^    def __init__(self):$/", "language": "Python", "kind": "member", "signature": "(self)", "scope": "InMemoryRideBroker", "scopeKind": "class"}, {"_type": "tag", "name": "__init__", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^    def __init__(self, ride_id: UUID):$/", "language": "Python", "kind": "member", "signature": "(self, ride_id: UUID)", "scope": "RideRoom", "scopeKind": "class"}, {"_type": "tag", "name": "_close_code", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^def _close_code(code: int) -> int:$/", "language": "Python", "typeref": "typename:int", "kind": "function", "signature": "(code: int)"}, {"_type": "tag", "name": "_extract_token_from_ws", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^def _extract_token_from_ws(websocket: WebSocket) -> Optional[str]:$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "function", "signature": "(websocket: WebSocket)"}, {"_type": "tag", "name": "_heartbeat_sender", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^async def _heartbeat_sender(conn: Connection, stop_event: asyncio.Event) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(conn: Connection, stop_event: asyncio.Event)"}, {"_type": "tag", "name": "_safe_send_json", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^async def _safe_send_json(conn: Connection, payload: dict[str, Any]) -> bool:$/", "language": "Python", "typeref": "typename:bool", "kind": "function", "signature": "(conn: Connection, payload: dict[str, Any])"}, {"_type": "tag", "name": "add", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^    async def add(self, conn: Connection, channel: str) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, conn: Connection, channel: str)", "scope": "RideRoom", "scopeKind": "class"}, {"_type": "tag", "name": "authenticate_ws_user", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^async def authenticate_ws_user(websocket: WebSocket, db: Session) -> User:$/", "language": "Python", "typeref": "typename:User", "kind": "function", "signature": "(websocket: WebSocket, db: Session)"}, {"_type": "tag", "name": "authorize_ws_ride_access", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^def authorize_ws_ride_access(user: User, ride: Ride, channel: str) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(user: User, ride: Ride, channel: str)"}, {"_type": "tag", "name": "broadcast_to_ride", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^async def broadcast_to_ride($/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "( ride_id: UUID, payload: dict[str, Any], *, to_riders: bool = True, to_drivers: bool = True, to_admins: bool = True, )"}, {"_type": "tag", "name": "broker", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^broker = InMemoryRideBroker()$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "cleanup_if_empty", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^    async def cleanup_if_empty(self, ride_id: UUID) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, ride_id: UUID)", "scope": "InMemoryRideBroker", "scopeKind": "class"}, {"_type": "tag", "name": "get_room", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^    async def get_room(self, ride_id: UUID) -> RideRoom:$/", "language": "Python", "typeref": "typename:RideRoom", "kind": "member", "signature": "(self, ride_id: UUID)", "scope": "InMemoryRideBroker", "scopeKind": "class"}, {"_type": "tag", "name": "remove", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^    async def remove(self, user_id: UUID) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, user_id: UUID)", "scope": "RideRoom", "scopeKind": "class"}, {"_type": "tag", "name": "run_ws_session", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^async def run_ws_session($/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "( websocket: WebSocket, *, db: Session, ride_id: UUID, channel: str, )"}, {"_type": "tag", "name": "snapshot", "path": "/home/kavia/workspace/code-generation/rideconnect-201071-201080/taxi_backend/src/api/realtime.py", "pattern": "/^    async def snapshot(self) -> dict[str, Any]:$/", "language": "Python", "typeref": "typename:dict[str,Any]", "kind": "member", "signature": "(self)", "scope": "RideRoom", "scopeKind": "class"}], "hash": "a93a5b644daa4f11bc1ba7cb8dc352ea", "format-version": 4, "code-base-name": "taxi_backend", "filename": "taxi_backend/src/api/realtime.py", "fields": [{"name": "MAX_CONSECUTIVE_SEND_TIMEOUTS = 3", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "PING_INTERVAL_SECONDS = 20", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "SEND_TIMEOUT_SECONDS = 3", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "broker = InMemoryRideBroker()", "scope": "", "scopeKind": "", "description": "unavailable"}]}